---
title: "JD Website"
author: "Jorge David Morales"
date: "`r Sys.Date()`"
#output: 
#  html_document:
#    theme: simplex
#    toc: true
#    toc_depth: 2
#    toc_float: true
---

# COVID-19

```{r, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(directlabels)
library(knitr)
library(kableExtra)
```

Información tomada de: https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data   
GitHub de la Universidad Johns Hopkins, US.  

```{r, include=FALSE}
# Internet Data
covid19 <- read.csv("http://query.data.world/s/cdc5dussbvmp52xnluz6wvyntjn6am",
                    header = T, stringsAsFactors = F)
```

```{r, include=FALSE}
# Johns Hopkins Dataset
covid19.jh.c <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv",
                       header = T, sep = ",", stringsAsFactors = F)

covid19.jh.r <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv",
                       header = T, sep = ",", stringsAsFactors = F)

covid19.jh.d <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv",
                       header = T, sep = ",", stringsAsFactors = F)
```

```{r, include=FALSE}
# Data Analysis

# Confirmed
covid19.jh.c <- covid19.jh.c %>% 
  select(-c(Province.State, Lat, Long)) %>% 
  gather(key = "Report.Date", value = "Confirmed.p", -Country.Region) %>% 
  mutate(Report.Date = as.Date(str_remove(Report.Date, "X"), '%m.%d.%y')) %>% 
  group_by(Country.Region, Report.Date) %>% 
  summarise(Confirmed = sum(Confirmed.p)) %>% 
  arrange(Report.Date) 

# Recovered
covid19.jh.r <- covid19.jh.r %>% 
  select(-c(Province.State, Lat, Long)) %>% 
  gather(key = "Report.Date", value = "Recovered.p", -Country.Region) %>% 
  mutate(Report.Date = as.Date(str_remove(Report.Date, "X"), '%m.%d.%y')) %>% 
  group_by(Country.Region, Report.Date) %>% 
  summarise(Recovered = sum(Recovered.p)) %>% 
  arrange(Report.Date)

# Deaths
covid19.jh.d <- covid19.jh.d %>% 
  select(-c(Province.State, Lat, Long)) %>% 
  gather(key = "Report.Date", value = "Deaths.p", -Country.Region) %>% 
  mutate(Report.Date = as.Date(str_remove(Report.Date, "X"), '%m.%d.%y')) %>% 
  group_by(Country.Region, Report.Date) %>% 
  summarise(Deaths = sum(Deaths.p)) %>% 
  arrange(Report.Date)

# Consolidado
covid19.jh <- covid19.jh.c %>% 
  left_join(covid19.jh.r, by = c("Country.Region", "Report.Date")) %>%
  left_join(covid19.jh.d, by = c("Country.Region", "Report.Date")) %>% 
  select(Report.Date, everything()) %>% 
  group_by(Country.Region) %>% 
  mutate(Confirmed = ifelse(Country.Region=='Peru' & Report.Date=='2020-03-20',263,Confirmed),
         Confirmed = ifelse(Country.Region=='Chile' & Report.Date=='2020-03-19',342,Confirmed),
         New.Cases = Confirmed - lag(Confirmed, order_by = Report.Date),
         New.Cases = ifelse(is.na(New.Cases),0,New.Cases),
         Actives = Confirmed - Recovered - Deaths,
         Recov.Rate = ifelse(Confirmed==0,0,round(Recovered/Confirmed,3)),
         Death.Rate = ifelse(Confirmed==0,0,round(Deaths/Confirmed,3)))

# Last Report Date
Latest.Date <- max(covid19.jh$Report.Date)
```

```{r, echo=FALSE}
print(paste0("Fecha de último reporte: ", Latest.Date), quote = F)
```

```{r, echo=FALSE}
# Resumen
covid19.jh %>% 
  filter(Country.Region %in% c('Peru','Ecuador','Colombia','Chile','Brazil','Venezuela') &
           Report.Date == Latest.Date) %>% 
  mutate(Death.Rate = scales::percent(Death.Rate),
         Recov.Rate = scales::percent(Recov.Rate)) %>% 
  arrange(desc(Confirmed)) %>% 
  kable() %>% 
  kable_styling(fixed_thead = T,
                bootstrap_options = c("striped", "hover", "condensed"))
```

```{r, echo=FALSE, message=FALSE}
p <- covid19.jh %>% 
  filter(Country.Region %in% c('Peru','Ecuador','Colombia','Chile','Brazil','Venezuela') & 
           Report.Date >= '2020-03-10') %>% 
  arrange(desc(Report.Date)) %>% 
  ggplot(aes(y = Confirmed, x = Report.Date, group=Country.Region, color=Country.Region)) +
  geom_line(size=1) + 
  geom_point(size=3, shape=21, fill="white") +
  ggtitle("Tendencia Exponencial COVID-19") +
  geom_dl(aes(label = Country.Region), method = list("last.points",cex=0.8,vjust=-0.8, hjust=0.5)) +
  theme_minimal() 

p + theme(legend.position="none",
          axis.title = element_blank())
```

```{r, echo=FALSE, message=FALSE}
q <- covid19.jh %>% 
  filter(Country.Region %in% c('Peru','Ecuador','Colombia','Chile','Brazil','Venezuela') & 
           Report.Date >= '2020-03-10') %>% 
  arrange(desc(Report.Date)) %>% 
  ggplot(aes(x=Report.Date, y=New.Cases, fill=Country.Region)) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_smooth() +
  facet_wrap(~Country.Region) +
  ggtitle("Nuevos Casos Confirmados") +
  theme_minimal()
 
q + theme(legend.position = "none",
          axis.title = element_blank(),
          axis.text.x = element_text(angle = 90, hjust = 0)) 
```




